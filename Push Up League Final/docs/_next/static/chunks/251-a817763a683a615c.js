"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[251],{8251:function(e,t,a){a.r(t),a.d(t,{SyncManager:function(){return n},syncManager:function(){return l},useManualSync:function(){return u},useSyncManager:function(){return c}});var o=a(2249),s=a(2265),r=a(3754),i=a(6410);class n{static getInstance(){return n.instance||(n.instance=new n),n.instance}initialize(){this.loadFromLocalStorage(),console.log("\uD83D\uDCE6 Loaded data from localStorage"),(0,i.w7)(e=>{e?this.handleUserLogin(e):this.handleUserLogout()}),this.unsubscribeAutoSync||(this.unsubscribeAutoSync=r.CT.subscribe((e,t)=>{e.isAuthenticated&&e.userId&&!this.suppressAutoSync&&e!==t&&(this.autoSyncTimer&&clearTimeout(this.autoSyncTimer),this.autoSyncTimer=setTimeout(()=>{this.syncToFirebase().catch(e=>{console.error("❌ Auto-sync failed:",e)})},1e4))}))}async waitForLoginLoad(){this.loginLoadPromise&&(console.log("⏳ Waiting for login data load to complete..."),await this.loginLoadPromise,console.log("✅ Login data load complete!"))}async handleUserLogin(e){let t=r.CT.getState();this.loginLoadPromise=new Promise(e=>{this.loginLoadResolve=e});try{this.suppressAutoSync=!0,console.log("\uD83D\uDD04 Loading user data from Firebase for:",e.uid);let o=null,s=await (0,i.et)(e.uid);if(s){if(console.log("✅ Profile loaded from Firebase:",s),console.log("☁️ Firebase has: ".concat(s.totalXp," XP, streak ").concat(s.currentStreak)),s.userId!==e.uid){console.warn("⚠️ Fixing userId mismatch: profile has ".concat(s.userId,", auth has ").concat(e.uid)),o=s.userId;let{updateUserProfile:t}=await Promise.resolve().then(a.bind(a,6410));await t(e.uid,{userId:e.uid})}t.setUserProfile(s.email,s.proficiency,s.maxPushupsInOneSet),r.CT.setState({userId:e.uid,username:s.username,email:s.email,isAuthenticated:!0,proficiency:s.proficiency,maxPushupsInOneSet:s.maxPushupsInOneSet,isWorldRecordCandidate:s.isWorldRecordCandidate,waiverAccepted:s.waiverAccepted||!1,waiverAcceptedAt:s.waiverAcceptedAt||null,waiverVersion:s.waiverVersion||null,waiverSignatureName:s.waiverSignatureName||null,accountCreatedAt:s.accountCreatedAt||null,totalXp:s.totalXp,coins:s.coins,currentRank:s.currentRank,currentStreak:s.currentStreak,longestStreak:s.longestStreak,lastWorkoutDate:s.lastWorkoutDate,personalBest:s.personalBest,dailyGoal:s.dailyGoal,streakFreezes:s.streakFreezes,bodyWeightKg:s.bodyWeightKg||77})}else{console.warn("⚠️ No profile found in Firebase for user:",e.uid),console.log("\uD83D\uDCE4 Creating new profile with local data...");let{createUserProfile:o}=await Promise.resolve().then(a.bind(a,6410));await o(e.uid,{username:t.username,email:t.email||e.email||"",proficiency:t.proficiency,maxPushupsInOneSet:t.maxPushupsInOneSet,isWorldRecordCandidate:t.isWorldRecordCandidate,totalXp:t.totalXp,coins:t.coins,currentRank:t.currentRank,currentStreak:t.currentStreak,longestStreak:t.longestStreak,lastWorkoutDate:t.lastWorkoutDate,personalBest:t.personalBest,dailyGoal:t.dailyGoal,streakFreezes:t.streakFreezes,bodyWeightKg:t.bodyWeightKg}),r.CT.setState({userId:e.uid,isAuthenticated:!0}),console.log("✅ Profile created in Firebase with local data")}let n=await (0,i.SB)(e.uid);if(console.log("\uD83D\uDCCA Loaded ".concat(n.length," workouts from Firebase")),0===n.length&&o){console.log("\uD83D\uDD04 No workouts found with new userId, checking for workouts with old userId: ".concat(o));let t=await (0,i.SB)(o);if(t.length>0){console.log("\uD83D\uDCE6 Found ".concat(t.length," workouts with old userId, migrating to new userId..."));let{db:o}=await Promise.resolve().then(a.bind(a,6410)),{doc:s,updateDoc:r}=await Promise.resolve().then(a.bind(a,5978));for(let a of t)try{await r(s(o,"workouts",a.id),{userId:e.uid}),console.log("✅ Migrated workout ".concat(a.id))}catch(e){console.error("❌ Failed to migrate workout ".concat(a.id,":"),e)}n=await (0,i.SB)(e.uid),console.log("✅ Migration complete! Loaded ".concat(n.length," workouts"))}}n.length>0?r.CT.setState({workouts:n.map(e=>({id:e.id,date:e.date,pushups:e.pushups,sets:e.sets,xpEarned:e.xpEarned,coinsEarned:e.coinsEarned||0,goalCompleted:e.goalCompleted||!1,streakMultiplier:e.streakMultiplier,challengeBonus:e.challengeBonus,isLocked:e.isLocked,lockedAt:e.lockedAt}))}):r.CT.setState({workouts:[]});try{let t=await (0,i.Mp)(e.uid);t.length>0&&r.CT.setState({achievements:t.map(e=>({id:e.id,title:e.title,description:e.description,unlockedAt:e.unlockedAt,type:e.type}))})}catch(e){console.warn("Could not load achievements from Firebase:",e)}this.unsubscribeWorkouts=(0,i.vA)(e.uid,e=>{console.log("\uD83D\uDD14 Real-time update: ".concat(e.length," workouts")),r.CT.setState({workouts:e.map(e=>({id:e.id,date:e.date,pushups:e.pushups,sets:e.sets,xpEarned:e.xpEarned,coinsEarned:e.coinsEarned||0,goalCompleted:e.goalCompleted||!1,streakMultiplier:e.streakMultiplier,challengeBonus:e.challengeBonus,isLocked:e.isLocked,lockedAt:e.lockedAt}))})}),this.suppressAutoSync=!1,this.loginLoadResolve&&(this.loginLoadResolve(),this.loginLoadResolve=null)}catch(e){console.error("❌ Error loading user data from Firebase:",e),this.suppressAutoSync=!1,this.loginLoadResolve&&(this.loginLoadResolve(),this.loginLoadResolve=null)}}handleUserLogout(){this.unsubscribeWorkouts&&(this.unsubscribeWorkouts(),this.unsubscribeWorkouts=null)}async syncToFirebase(){let e=r.CT.getState();if(!e.isAuthenticated||!e.userId){console.log("⏭️ Skipping sync - not authenticated");return}console.log("\uD83D\uDD04 Syncing to Firebase...");try{console.log("\uD83D\uDCE4 Uploading user profile to Firebase..."),await (0,i.updateUserProfile)(e.userId,{userId:e.userId,username:e.username,email:e.email,proficiency:e.proficiency,maxPushupsInOneSet:e.maxPushupsInOneSet,isWorldRecordCandidate:e.isWorldRecordCandidate,waiverAccepted:e.waiverAccepted,waiverAcceptedAt:e.waiverAcceptedAt,waiverVersion:e.waiverVersion,waiverSignatureName:e.waiverSignatureName,accountCreatedAt:e.accountCreatedAt,totalXp:e.totalXp,coins:e.coins,currentRank:e.currentRank,currentStreak:e.currentStreak,longestStreak:e.longestStreak,lastWorkoutDate:e.lastWorkoutDate,personalBest:e.personalBest,dailyGoal:e.dailyGoal,streakFreezes:e.streakFreezes,bodyWeightKg:e.bodyWeightKg,totalLifetimePushups:e.totalLifetimePushups,variationStats:e.variationStats,variationPBs:e.variationPBs,purchasedTitles:e.purchasedTitles,activeTitle:e.activeTitle,unlockedAchievements:e.unlockedAchievements}),console.log("✅ User profile synced to Firebase");let t=await (0,i.SB)(e.userId),a=new Set(t.map(e=>e.id)),o=0;for(let t of e.workouts)!a.has(t.id)&&(await (0,i.Mg)({...t,sets:t.sets,userId:e.userId,createdAt:null}),o++);o>0&&console.log("✅ Synced ".concat(o," new workout(s) to Firebase"));try{let t=await (0,i.Mp)(e.userId),a=new Set(t.map(e=>e.id));for(let t of e.achievements)a.has(t.id)||await (0,i.Sz)({...t,userId:e.userId})}catch(e){console.warn("Could not sync achievements to Firebase:",e)}this.lastSyncTimestamp=Date.now(),console.log("✅ Firebase sync complete")}catch(e){console.error("❌ Error syncing to Firebase:",e)}}async performPeriodicSync(){r.CT.getState().isAuthenticated&&await this.syncToFirebase()}saveToLocalStorage(){let e=r.CT.getState(),t={userId:e.userId,username:e.username,email:e.email,proficiency:e.proficiency,maxPushupsInOneSet:e.maxPushupsInOneSet,isWorldRecordCandidate:e.isWorldRecordCandidate,waiverAccepted:e.waiverAccepted,waiverAcceptedAt:e.waiverAcceptedAt,waiverVersion:e.waiverVersion,waiverSignatureName:e.waiverSignatureName,accountCreatedAt:e.accountCreatedAt,totalXp:e.totalXp,coins:e.coins,currentRank:e.currentRank,currentStreak:e.currentStreak,longestStreak:e.longestStreak,lastWorkoutDate:e.lastWorkoutDate,workouts:e.workouts,achievements:e.achievements,personalBest:e.personalBest,dailyGoal:e.dailyGoal,streakFreezes:e.streakFreezes,powerUpPurchaseHistory:e.powerUpPurchaseHistory,bodyWeightKg:e.bodyWeightKg,totalLifetimePushups:e.totalLifetimePushups,variationStats:e.variationStats,variationPBs:e.variationPBs,purchasedTitles:e.purchasedTitles,activeTitle:e.activeTitle,unlockedAchievements:e.unlockedAchievements,lastSyncTimestamp:this.lastSyncTimestamp};try{localStorage.setItem("pushup-league-data",JSON.stringify(t))}catch(e){console.error("Error saving to localStorage:",e)}}loadFromLocalStorage(){try{let e=localStorage.getItem("pushup-league-data");if(e){let t=JSON.parse(e);r.CT.setState({userId:t.userId,username:t.username,email:t.email,proficiency:t.proficiency||"beginner",maxPushupsInOneSet:t.maxPushupsInOneSet||10,isWorldRecordCandidate:t.isWorldRecordCandidate||!1,waiverAccepted:t.waiverAccepted||!1,waiverAcceptedAt:t.waiverAcceptedAt||null,waiverVersion:t.waiverVersion||null,waiverSignatureName:t.waiverSignatureName||null,accountCreatedAt:t.accountCreatedAt||null,totalXp:t.totalXp||0,coins:t.coins||0,currentRank:t.currentRank||1,currentStreak:t.currentStreak||0,longestStreak:t.longestStreak||0,lastWorkoutDate:t.lastWorkoutDate||null,workouts:t.workouts||[],achievements:t.achievements||[],personalBest:t.personalBest||0,dailyGoal:t.dailyGoal||50,streakFreezes:t.streakFreezes||1,powerUpPurchaseHistory:t.powerUpPurchaseHistory||r.CT.getState().powerUpPurchaseHistory,bodyWeightKg:t.bodyWeightKg||77,totalLifetimePushups:t.totalLifetimePushups||0,variationStats:t.variationStats||r.CT.getState().variationStats,variationPBs:t.variationPBs||r.CT.getState().variationPBs,purchasedTitles:t.purchasedTitles||[],activeTitle:t.activeTitle||null,unlockedAchievements:t.unlockedAchievements||[]}),this.lastSyncTimestamp=t.lastSyncTimestamp||0}}catch(e){console.error("Error loading from localStorage:",e)}}async forceSyncNow(){await this.syncToFirebase(),this.saveToLocalStorage()}cleanup(){this.unsubscribeWorkouts&&this.unsubscribeWorkouts(),this.syncInterval&&clearInterval(this.syncInterval),this.autoSyncTimer&&clearTimeout(this.autoSyncTimer),this.unsubscribeAutoSync&&(this.unsubscribeAutoSync(),this.unsubscribeAutoSync=null)}constructor(){(0,o._)(this,"unsubscribeWorkouts",null),(0,o._)(this,"syncInterval",null),(0,o._)(this,"autoSyncTimer",null),(0,o._)(this,"suppressAutoSync",!1),(0,o._)(this,"unsubscribeAutoSync",null),(0,o._)(this,"lastSyncTimestamp",0),(0,o._)(this,"loginLoadPromise",null),(0,o._)(this,"loginLoadResolve",null)}}(0,o._)(n,"instance",void 0);let l=n.getInstance();function c(){(0,s.useEffect)(()=>(l.initialize(),()=>{l.cleanup()}),[])}function u(){return{syncNow:()=>l.forceSyncNow(),saveLocal:()=>l.saveToLocalStorage()}}}}]);