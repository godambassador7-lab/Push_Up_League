"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[251],{8251:function(e,t,a){a.r(t),a.d(t,{SyncManager:function(){return n},syncManager:function(){return l},useManualSync:function(){return u},useSyncManager:function(){return c}});var s=a(2249),o=a(2265),i=a(3754),r=a(6410);class n{static getInstance(){return n.instance||(n.instance=new n),n.instance}initialize(){(0,r.w7)(e=>{e?this.handleUserLogin(e):this.handleUserLogout()}),this.unsubscribeAutoSync||(this.unsubscribeAutoSync=i.CT.subscribe((e,t)=>{e.isAuthenticated&&e.userId&&!this.suppressAutoSync&&e!==t&&(this.autoSyncTimer&&clearTimeout(this.autoSyncTimer),this.autoSyncTimer=setTimeout(()=>{this.syncToFirebase().catch(e=>{console.error("❌ Auto-sync failed:",e)})},1e4))}))}async waitForLoginLoad(){this.loginLoadPromise&&(console.log("⏳ Waiting for login data load to complete..."),await this.loginLoadPromise,console.log("✅ Login data load complete!"))}async handleUserLogin(e){let t=i.CT.getState();this.loginLoadPromise=new Promise(e=>{this.loginLoadResolve=e});try{this.suppressAutoSync=!0,console.log("\uD83D\uDD04 Loading user data from Firebase for:",e.uid);let s=[...t.workouts],o=t.totalXp;t.coins,console.log("\uD83D\uDCE6 Local state before sync: ".concat(s.length," workouts, ").concat(o," XP"));let n=await (0,r.et)(e.uid);if(n)console.log("✅ Profile loaded from Firebase:",n),console.log("☁️ Firebase has: ".concat(n.totalXp," XP, streak ").concat(n.currentStreak)),t.setUserProfile(n.email,n.proficiency,n.maxPushupsInOneSet),i.CT.setState({userId:e.uid,username:n.username,email:n.email,isAuthenticated:!0,proficiency:n.proficiency,maxPushupsInOneSet:n.maxPushupsInOneSet,isWorldRecordCandidate:n.isWorldRecordCandidate,waiverAccepted:n.waiverAccepted||!1,waiverAcceptedAt:n.waiverAcceptedAt||null,waiverVersion:n.waiverVersion||null,waiverSignatureName:n.waiverSignatureName||null,accountCreatedAt:n.accountCreatedAt||null,totalXp:n.totalXp,coins:n.coins,currentRank:n.currentRank,currentStreak:n.currentStreak,longestStreak:n.longestStreak,lastWorkoutDate:n.lastWorkoutDate,personalBest:n.personalBest,dailyGoal:n.dailyGoal,streakFreezes:n.streakFreezes,bodyWeightKg:n.bodyWeightKg||77,totalLifetimePushups:n.totalLifetimePushups||0,variationStats:n.variationStats||i.CT.getState().variationStats,variationPBs:n.variationPBs||i.CT.getState().variationPBs,purchasedTitles:n.purchasedTitles||[],activeTitle:n.activeTitle||null,unlockedAchievements:n.unlockedAchievements||[]});else{console.warn("⚠️ No profile found in Firebase for user:",e.uid),console.log("\uD83D\uDCE4 Creating new profile with local data...");let{createUserProfile:s}=await Promise.resolve().then(a.bind(a,6410));await s(e.uid,{username:t.username,email:t.email||e.email||"",proficiency:t.proficiency,maxPushupsInOneSet:t.maxPushupsInOneSet,isWorldRecordCandidate:t.isWorldRecordCandidate,totalXp:t.totalXp,coins:t.coins,currentRank:t.currentRank,currentStreak:t.currentStreak,longestStreak:t.longestStreak,lastWorkoutDate:t.lastWorkoutDate,personalBest:t.personalBest,dailyGoal:t.dailyGoal,streakFreezes:t.streakFreezes}),i.CT.setState({userId:e.uid,isAuthenticated:!0}),console.log("✅ Profile created in Firebase with local data")}let l=await (0,r.SB)(e.uid);if(console.log("\uD83D\uDCCA Loaded ".concat(l.length," workouts from Firebase")),0===l.length&&s.length>0){for(let t of(console.log("\uD83D\uDCE4 Firebase empty but found ".concat(s.length," local workouts - will upload")),i.CT.setState({userId:e.uid}),console.log("⬆️ Uploading local workouts to Firebase..."),s))await (0,r.Mg)({...t,sets:t.sets,userId:e.uid,createdAt:null});console.log("✅ Uploaded ".concat(s.length," workout(s) to Firebase"))}else l.length>0?(console.log("☁️ Using ".concat(l.length," workouts from Firebase")),i.CT.setState({workouts:l.map(e=>({id:e.id,date:e.date,pushups:e.pushups,sets:e.sets,xpEarned:e.xpEarned,coinsEarned:e.coinsEarned||0,goalCompleted:e.goalCompleted||!1,streakMultiplier:e.streakMultiplier,challengeBonus:e.challengeBonus,isLocked:e.isLocked,lockedAt:e.lockedAt}))})):console.log("ℹ️ No workouts in Firebase or locally");try{let t=await (0,r.Mp)(e.uid);t.length>0&&i.CT.setState({achievements:t.map(e=>({id:e.id,title:e.title,description:e.description,unlockedAt:e.unlockedAt,type:e.type}))})}catch(e){console.warn("Could not load achievements from Firebase:",e)}this.unsubscribeWorkouts=(0,r.vA)(e.uid,e=>{console.log("\uD83D\uDD14 Real-time update: ".concat(e.length," workouts")),i.CT.setState({workouts:e.map(e=>({id:e.id,date:e.date,pushups:e.pushups,sets:e.sets,xpEarned:e.xpEarned,coinsEarned:e.coinsEarned||0,goalCompleted:e.goalCompleted||!1,streakMultiplier:e.streakMultiplier,challengeBonus:e.challengeBonus,isLocked:e.isLocked,lockedAt:e.lockedAt}))})}),this.suppressAutoSync=!1,this.loginLoadResolve&&(this.loginLoadResolve(),this.loginLoadResolve=null)}catch(e){console.error("❌ Error loading user data from Firebase:",e),this.suppressAutoSync=!1,this.loginLoadResolve&&(this.loginLoadResolve(),this.loginLoadResolve=null)}}handleUserLogout(){this.unsubscribeWorkouts&&(this.unsubscribeWorkouts(),this.unsubscribeWorkouts=null)}async syncToFirebase(){let e=i.CT.getState();if(!e.isAuthenticated||!e.userId){console.log("⏭️ Skipping sync - not authenticated");return}console.log("\uD83D\uDD04 Syncing to Firebase...");try{console.log("\uD83D\uDCE4 Uploading user profile to Firebase..."),await (0,r.Lj)(e.userId,{userId:e.userId,username:e.username,email:e.email,proficiency:e.proficiency,maxPushupsInOneSet:e.maxPushupsInOneSet,isWorldRecordCandidate:e.isWorldRecordCandidate,waiverAccepted:e.waiverAccepted,waiverAcceptedAt:e.waiverAcceptedAt,waiverVersion:e.waiverVersion,waiverSignatureName:e.waiverSignatureName,accountCreatedAt:e.accountCreatedAt,totalXp:e.totalXp,coins:e.coins,currentRank:e.currentRank,currentStreak:e.currentStreak,longestStreak:e.longestStreak,lastWorkoutDate:e.lastWorkoutDate,personalBest:e.personalBest,dailyGoal:e.dailyGoal,streakFreezes:e.streakFreezes,bodyWeightKg:e.bodyWeightKg,totalLifetimePushups:e.totalLifetimePushups,variationStats:e.variationStats,variationPBs:e.variationPBs,purchasedTitles:e.purchasedTitles,activeTitle:e.activeTitle,unlockedAchievements:e.unlockedAchievements}),console.log("✅ User profile synced to Firebase");let t=await (0,r.SB)(e.userId),a=new Set(t.map(e=>e.id)),s=0;for(let t of e.workouts)!a.has(t.id)&&(await (0,r.Mg)({...t,sets:t.sets,userId:e.userId,createdAt:null}),s++);s>0&&console.log("✅ Synced ".concat(s," new workout(s) to Firebase"));try{let t=await (0,r.Mp)(e.userId),a=new Set(t.map(e=>e.id));for(let t of e.achievements)a.has(t.id)||await (0,r.Sz)({...t,userId:e.userId})}catch(e){console.warn("Could not sync achievements to Firebase:",e)}this.lastSyncTimestamp=Date.now(),console.log("✅ Firebase sync complete")}catch(e){console.error("❌ Error syncing to Firebase:",e)}}async performPeriodicSync(){i.CT.getState().isAuthenticated&&await this.syncToFirebase()}saveToLocalStorage(){let e=i.CT.getState(),t={userId:e.userId,username:e.username,email:e.email,proficiency:e.proficiency,maxPushupsInOneSet:e.maxPushupsInOneSet,isWorldRecordCandidate:e.isWorldRecordCandidate,waiverAccepted:e.waiverAccepted,waiverAcceptedAt:e.waiverAcceptedAt,waiverVersion:e.waiverVersion,waiverSignatureName:e.waiverSignatureName,accountCreatedAt:e.accountCreatedAt,totalXp:e.totalXp,coins:e.coins,currentRank:e.currentRank,currentStreak:e.currentStreak,longestStreak:e.longestStreak,lastWorkoutDate:e.lastWorkoutDate,workouts:e.workouts,achievements:e.achievements,personalBest:e.personalBest,dailyGoal:e.dailyGoal,streakFreezes:e.streakFreezes,powerUpPurchaseHistory:e.powerUpPurchaseHistory,bodyWeightKg:e.bodyWeightKg,totalLifetimePushups:e.totalLifetimePushups,variationStats:e.variationStats,variationPBs:e.variationPBs,purchasedTitles:e.purchasedTitles,activeTitle:e.activeTitle,unlockedAchievements:e.unlockedAchievements,lastSyncTimestamp:this.lastSyncTimestamp};try{localStorage.setItem("pushup-league-data",JSON.stringify(t))}catch(e){console.error("Error saving to localStorage:",e)}}loadFromLocalStorage(){try{let e=localStorage.getItem("pushup-league-data");if(e){let t=JSON.parse(e);i.CT.setState({userId:t.userId,username:t.username,email:t.email,proficiency:t.proficiency||"beginner",maxPushupsInOneSet:t.maxPushupsInOneSet||10,isWorldRecordCandidate:t.isWorldRecordCandidate||!1,waiverAccepted:t.waiverAccepted||!1,waiverAcceptedAt:t.waiverAcceptedAt||null,waiverVersion:t.waiverVersion||null,waiverSignatureName:t.waiverSignatureName||null,accountCreatedAt:t.accountCreatedAt||null,totalXp:t.totalXp||0,coins:t.coins||0,currentRank:t.currentRank||1,currentStreak:t.currentStreak||0,longestStreak:t.longestStreak||0,lastWorkoutDate:t.lastWorkoutDate||null,workouts:t.workouts||[],achievements:t.achievements||[],personalBest:t.personalBest||0,dailyGoal:t.dailyGoal||50,streakFreezes:t.streakFreezes||1,powerUpPurchaseHistory:t.powerUpPurchaseHistory||i.CT.getState().powerUpPurchaseHistory,bodyWeightKg:t.bodyWeightKg||77,totalLifetimePushups:t.totalLifetimePushups||0,variationStats:t.variationStats||i.CT.getState().variationStats,variationPBs:t.variationPBs||i.CT.getState().variationPBs,purchasedTitles:t.purchasedTitles||[],activeTitle:t.activeTitle||null,unlockedAchievements:t.unlockedAchievements||[]}),this.lastSyncTimestamp=t.lastSyncTimestamp||0}}catch(e){console.error("Error loading from localStorage:",e)}}async forceSyncNow(){await this.syncToFirebase(),this.saveToLocalStorage()}cleanup(){this.unsubscribeWorkouts&&this.unsubscribeWorkouts(),this.syncInterval&&clearInterval(this.syncInterval),this.autoSyncTimer&&clearTimeout(this.autoSyncTimer),this.unsubscribeAutoSync&&(this.unsubscribeAutoSync(),this.unsubscribeAutoSync=null)}constructor(){(0,s._)(this,"unsubscribeWorkouts",null),(0,s._)(this,"syncInterval",null),(0,s._)(this,"autoSyncTimer",null),(0,s._)(this,"suppressAutoSync",!1),(0,s._)(this,"unsubscribeAutoSync",null),(0,s._)(this,"lastSyncTimestamp",0),(0,s._)(this,"loginLoadPromise",null),(0,s._)(this,"loginLoadResolve",null)}}(0,s._)(n,"instance",void 0);let l=n.getInstance();function c(){(0,o.useEffect)(()=>(l.initialize(),()=>{l.cleanup()}),[])}function u(){return{syncNow:()=>l.forceSyncNow(),saveLocal:()=>l.saveToLocalStorage()}}}}]);